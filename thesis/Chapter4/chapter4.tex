\section{How to improve security for Identity federations}
\section{How to combine Identity federations and DANE}
As stated earlier it's possible to divide federations into two categories, those with a federation provider and those without.
In the analysis that has been done the solution with a federation provider is the most probable and viable setup in the long run, it's basiclly much easier to scale, both technically and non-technically.
It's with this configuration in mind the following evaluation has been made.

%TODO: (1) Kontrollera att det finns information om b책da kategorierna av federationer.
%TODO: (2) Kontrollera att analys 채r gjord och att det verkligen 채r varianten med en FO som 채r mest trolig.

With a federation provider publishing all the metadata about all service providers, identity providers and other entities how do the trusting entites rely on the federation provider?
Is it the correct federation provider the trusting entities connect to or is it someone trying to "impersonate" the role of the federation provider as a man-in-the-middle attack.

As of now the trust must be made in some out-of-band way e.g. a simple download of the federation provider's certificate and then confirm it's the correct one via telephone, email communcation between administrators or meet in person.
This is not very practical when the federation grows bigger with tenths or hundreds of service- and identity providers or is it the only way?
\subsection{The publishing problem}
\subsubsection{SAML2 certificate as CERT resource record}
\label{subsec:saml2-certificate-as-tlsa}
The first solution that comes into mind is that it might be possible to publish the federation provider's certificate in the DNS system and more specifically as a CERT RR\cite{rfc:4398}.
This would mean that when a requesting entity (service provider, identity provider or any other entity) needs to update the metadata about all other entities it connects to the federation provider and downloads the metadata.
At the same time the requesting entity sends out a DNS lookup (with DNSSEC active) for a corresponding CERT RR.
When both the metadata and the CERT RR is retrieved, a comparison can be made and confirm or dismiss the validity of the metadata.

A problem that still exists with this approach is how will the metadata about each entity be transmitted to the federation provider and validated by the federation provider.
To keep building on the same solution each entity would have to publish respective certificate as a CERT RR themselves in their own domain zone.
They would also need sign their own metadata which is not the case at the moment. 
Now the initial upload of metadata from an entity to the federation provider could be intitated, perhaps through a web interface, with or without some "Pretty Good Privacy" (PGP) solution e.g. OpenPGP\cite{rfc:2440}.
% TODO: Add use cases from registry->registrar in DNS and how it is used their.
The federation provider than fetches the metadata aswell as the corresponding CERT RR from the entity and if it's the correct signature on it the federation provider can publish it with the metadata from all other entities.
Within one cache interval all entities will now fetch the complete updated metadata from the federation provider.

% TODO: What is a cache interval?
% TODO: What is a domain zone?

New questions arises here, is it practical to store SAML2 certificates in the DNS system as a CERT RR?
The second question that comes to mind is more related to DANE.
If CERT RRs is used as stated above it would require DNSSEC otherwise its value would be of no use.
Is it not possible to just use the TLSA RR with TLS certificates as it is and not introduce another layer that CERT RRs would become within the same system (DNS and DNSSEC)?

\subsubsection{Only use TLS (with TLSA RR)}
\label{subsec:only-tlsa-rr-with-tls}
Let's start with the second question and get back to the first one later on.
The solution is already at the point where all entities within a federation needs to sign their own zone with DNSSEC as an underlying infrastructure.
Instead of publishing SAML2 certificates in the DNS system it might be possible to just use the TLSA RRs with TLS and deem that all the information communicated between any two entities is valid as long as it's over TLS that has been established with TLSA RRs procedures.

This would mean that when a new entity, let's say a service provider, joins a federation the service provider must send its metadata to the federation provider.
As an example the administrator for the service provider might visit a webpage over https(with validity check for TLSA RR) to initiate the transfer of metadata.
The federation provider than opens a new connection over https(with validity check for TLSA RR) for the metadata from the service provider.
This request from the frederation provider back to the requesting service provider is to make sure that the metadata that is fetched is from the right service provider. 
When the metadata is recieved the federation provider can publish it with the metadata for all other entities.

% TODO: What is metadata?
% TODO: What is an entity?

\subsubsection{Publishing SAML2 certificate as CERT RR, is it viable?}
\label{subsec:saml2-certs-in-cert-rr}
Earlier in subsection \ref{subsec:saml2-certificate-as-tlsa} the question arose if it is practical to store SAML2 certificates in the DNS system.
As this is out of scope of this report further investigations has to be done in this area.
For further discussions it's assumed that it's a viable solution to store SAML2 certificates in the DNS system as CERT RRs.

\subsubsection{Using the best of two worlds}
It's often the simple solutions that are the best ones but would it be worth it to use TLSA validated connection for the https communication as described in section \ref{subsec:only-tlsa-rr-with-tls} together with the SAML2 certificates in CERT RRs explained in section \ref{subsec:saml2-certificate-as-tlsa}?
To simplify the view an argument could be made that the validity check on the SAML2 certficate downloaded over the https secure channel and then verified against the CERT RR is just another safety check within the same "layer" as the secure channel was established in.
The reason for this is that the TLS connection is validated first with information from the DNSSEC infrastructure, when requesting the TLSA RR.
The second validation is made depending on the TLSA RR information and local policies, it confirms that the TLS server certificate chain is to be trusted or not.
The third validation would be when the SAML2 certificate is compared against the CERT RR available within the DNSSEC infrastructure.

As noted the first and the third validation are both trusting the DNSSEC infrastructure, and therefore the combination of both using TLS with TLSA and SAML2 certificate with CERT RRs would at first glance not add any extra benefits.
Though under some circumstances someone might be able to hack into a webserver for some entity and change the SAML2 certificate, the third validation check against the CERT RR would in this case fail.
So in the end the question boils down to if the communication is secure to the correct host is this enough to trust everything that the host send?

\subsection{The matching dilemma}
\label{subsec:matching-dilemma}
The last section was about how to distribute the certificate within the DNS system and if it's necessary or not.
The CERT RR is mentioned as a possible solution and there might be several other solutions aswell.
If it's decided upon that a TLSA validated TLS connection is not enough to trust the data that is being sent the SAML2 certificates must be published aswell in the DNS system.
With a single or just a few certificates that signs all metadata files for the federation provider it's relatively easy to publish the certificates in the DNS system and fetch all of them based on the domain/subdomain.
Though it would put an unwanted limit that the federation provider is only allowed to use a few certificates per DNS zone.
Of course it would work with several hundred certificates but it wouldn't be a very good solution.
This is because each time some entity would check if the certificate is the correct one the requesting entity would have to download all certificates through the DNS system and then one by one try to match them against the certificate used in the metadata file.

This means that somekind of general algorithm/solution is required to locate the correct certificate published in the DNS system when an entity recieves a signed metadata file.
One way of doing this might be with the "Dynamic Delegation Discovery System (DDDS)"\cite{rfc:3401,rfc:3402,rfc:3403,rfc:3404} and the NAPTR resource record\cite{rfc:3403}. Exactly how this could be done is out of the scope of this report.

\section{How DANE can be implemented in Shibboleth} 
Test
% TODO: More research into this? Perhaps we will give an answer to this that is enough.

%\section{Temporary section}
%EVALUATION This is where you put the spotlight on your solution's strengths and
%weaknesses. An evaluation must be made of the methods/theory applied and the validity
%and reliability of the data. You should describe the most interesting results of your work in a
%results section. Remember that less important but complementary results can to advantage
%be placed in appendices. A rule of thumb is that all results that you use in your analysis and
%in your conclusions should be reported in the Evaluation chapter and the rest reported in
%appendices.

